<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UVA RDS - Journals by Provider</title>

  {% load static %}

  <!-- MDB icon -->
  <link rel="icon" href="{% static 'app/img/uva_logo.png' %}" type="image/x-icon">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="{% static 'app/css/bootstrap.min.css' %}">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="{% static 'app/css/mdb.min.css' %}">
  <!-- MDBootstrap Datatables  -->
  <link rel="stylesheet" href="{% static 'app/css/addons/datatables.min.css' %}">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" href="{% static 'app/css/style.css' %}">

  <style type="text/css">
    nav {
          background-color: #232d4b;
        }

        a.btn {
          background-color: #E57200;
        }

        #breadcrumb_container > div {
          background-color: #141e3c;
        }

        #breadcrumb_container a {
          color: #E57200;
        }

        #breadcrumb_container i {
          font-size: 12px;
        }

        hr {
          margin-bottom: 0;
        }

        #loader .d-flex {
          height: 475px;
        }

        #loader .spinner-border {
          width: 3rem; 
          height: 3rem; 
          color: #E57200;
        }

        .chart {
          height: 475px;
        }
    
  </style>
</head>
<body>

  <!--Navbar-->
  <nav class="navbar navbar-dark">
    <a class="navbar-brand" href="{% url 'app:index' %}">
      <img src="{% static 'app/img/uva_library_logo.svg' %} " height="30" alt="UVA Library">
    </a>
    {% if user.is_authenticated %}
        <a class="btn btn-sm my-2 my-sm-0 rounded text-white" href="{% url 'app:logout' %}">Logout</a>
    {% else %}
        <a class="btn btn-sm my-2 my-sm-0 rounded text-white" href="{% url 'app:login' %}">Login</a>
    {% endif %}
  </nav>
  <!-- Navbar -->

  <main>
    <!-- Breadcrumb Start -->
    <div class="container-fluid" id="breadcrumb_container">
      <div class="row pt-3">
        <p class="ml-4 text-white"><a href="{% url 'app:tools' %}">All Tools</a>  <i class="fas fa-chevron-right mx-2"></i> Journals by Discipline</p>
      </div>
    </div>
    <!-- Breadcrumb End -->
    
    <!-- Description Section Start -->
    <div class="container my-5" id="title_description">
      <h3 class="mb-4">Journals by Discipline Tool</h3>
      <p>Descriptions and important notes</p>
    </div>
    <!-- Description Section End -->

    <hr class="orange lighten-4">

    <div class="container-fluid" id="metrics_data">
      <div class="row">

        <!-- Metrics Column Start -->
        <div class="col-md-3 pt-3 border-right grey lighten-5" id="metrics_column">
          <div class="ml-2"> 
            <h4 class="mb-4">Providers</h4>

            <select class="browser-default custom-select mb-5" id="provider_select">
              <option>Select Provider</option>
            </select>

          </div>
        </div>
        <!-- Metrics Column End -->

        <!-- Spinners and Charts Start -->
        <div class="col-md-9" id="loader">
          <div class="d-flex justify-content-center align-items-center">
            <div class="spinner-border" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </div>
        <div class="col-md-8" id="charts_div">
          <div id="charts">
            <div class="chart" id="charts_journal_by_provider" class="mt-3"></div>  
          </div>
        </div>
        <!-- Spinners and Charts End -->
      </div>
    </div>
  </main>
  
  <!-- jQuery -->
  <script type="text/javascript" src="{% static 'app/js/jquery.min.js' %}"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="{% static 'app/js/popper.min.js' %}"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="{% static 'app/js/bootstrap.min.js' %}"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="{% static 'app/js/mdb.min.js' %}"></script>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>  
  <!-- Your custom scripts (optional) -->
  <script type="text/javascript">

    function resetMetricColumnHeight() {
      // Sets the height of the metrics column.

      // When one or fewer graphs are showing
      if( $("#charts > :visible").length <= 1) {
        // Adjust the height with the body of the function below
        $('#metrics_column').height( function() {
          var ret = 0;
          // If on a mobile device
          if( $(document).width() < 768) {
            heights = 0;
            // Add up the heights, margins (top and bottom), and padding (top and bottom) of all of the elements in the metrics column. 
            $('#metrics_column').children().each( function() {
              marginTop = parseInt($(this).css("marginTop").substring(0, $(this).css("marginTop").indexOf('px')));
              marginBottom = parseInt($(this).css("marginBottom").substring(0, $(this).css("marginBottom").indexOf('px')));
              paddingTop = parseInt($(this).css("paddingTop").substring(0, $(this).css("paddingTop").indexOf('px')));
              paddingBottom = parseInt($(this).css("paddingBottom").substring(0, $(this).css("paddingBottom").indexOf('px')));
              heights = heights + marginTop + marginBottom + paddingTop + paddingBottom + $(this).height();
              // console.log($(this).attr('id') + ": " + heights);
            });

            // Add 64 pixels to that total height            
            return heights + 64;
          }
          // Otherwise,
          else {
            // Add up the heights, margins (top and bottom), and padding (top and bottom) of all of the elements about the graphs and columns
            elements = ['nav', '#breadcrumb_container', '#title_description', 'hr'];
            heights = 0;
            $(elements.join(', ')).each( function() {
              marginTop = parseInt($(this).css("marginTop").substring(0, $(this).css("marginTop").indexOf('px')));
              marginBottom = parseInt($(this).css("marginBottom").substring(0, $(this).css("marginBottom").indexOf('px')));
              paddingTop = parseInt($(this).css("paddingTop").substring(0, $(this).css("paddingTop").indexOf('px')));
              paddingBottom = parseInt($(this).css("paddingBottom").substring(0, $(this).css("paddingBottom").indexOf('px')));
              heights = heights + marginTop + marginBottom + paddingTop + paddingBottom + $(this).height();
              // console.log($(this).attr('id')+ ": " + heights);
            });
            
            // Subtract that total from the height of the window (not document)
            return $(document).height() - heights - 1;
          }

        });
      }
      // Otherwise (when 2 or more graphs are showing), let CSS naturally handling the height
      else {
        $('#metrics_column').height("auto");
      }
      
    }   

    function loadProvidersListIntoColumn(providersList) {
      // Loads the list of providers into the dropdown.

      for(var i = 0; i < providersList.length; i++) {
        var newOption = document.createElement('option');
        newOption.setAttribute('value', providersList[i]);
        if(i == 0) newOption.selected = true;
        newOption.innerHTML = providersList[i];
        $( "#provider_select" ).append(newOption);
        // console.log(providersList[i]);
      }
    }

    function setChart(chartData) {
      // Creates the charts
      var chartConfig = {
        chart: {
            type: 'bar'
        },
        title: {
            text: 'Journals by Provider',
            fontFamily: 'Segoe UI',
            style: {
              fontWeight: 10,
              fontSize: 20,
            }
        },
        xAxis: {
            categories: Object.keys(chartData),
            tickLength: 0
        },
        yAxis: {
            title: {
                text: 'Number of Journals'
            }
        },
        legend: {
            enabled: false
        },
        series: [{
            name: 'Journals',
            data: Object.values(chartData),
        }],
        credits: {
            enabled: false
        },
      };

      Highcharts.chart('charts_journal_by_provider', chartConfig); 
        
    }

    $(document).ready( function () {
      // Start out by hiding the loader
      $("#loader").hide();      
      
      // Asynchronously fetch and load the providers dropdown
      $.ajax({
        // url : "https://onefigrapp.herokuapp.com/app/journals-by-provider/providers-list",
        url : "http://localhost:8000/app/journals-by-provider/providers-list",
        dataType: "json",
        success : function (data) {
          var providersList = data;
          console.log("AJAX providersList");
          console.log(providersList);
          loadProvidersListIntoColumn(providersList);
        }
      });

      // Asynchronously fetch and load the default AIP data into the graph
      $.ajax({
        // url : "https://onefigrapp.herokuapp.com/app/journals-by-provider/chart-data/AIP",
        url : "http://localhost:8000/app/journals-by-provider/chart-data/AIP/",
        dataType: "json",
        beforeSend: function () {
          // Show the spinner while fetching
          $("#charts_div").hide();
          $("#loader").show();
          
        },
        complete: function () {
          // As soon as data is fetched, show the graphs
          $("#charts_div").show();
          $("#loader").hide();
        },
        success : function (data) {
          // Load the data into the graphs
          var chartData = data;
          console.log("Chart Data");
          console.log(chartData);
          setChart(chartData);
          // setTable(chartData, metrics);
          
        }
      });

      resetMetricColumnHeight();
    });
    
    $("#provider_select").on("change", function() {
        // Whenever the provider dropdown changes, make sure the default "Select Provider" option isn't selected and then load the data
        // into the graphs and table.
        if( $("#provider_select").val() != $("#provider_select").children().first().val() ) {
          var queryURL = "http://localhost:8000/app/journals-by-provider/chart-data/" + encodeURI($("#provider_select").val()) + "/";
          // var queryURL = "https://onefigrapp.herokuapp.com/app/journals-by-provider/chart-data/" + encodeURI($("#provider_select").val()) + "/";
          console.log(queryURL);
          $.ajax({
            url : queryURL,
            dataType: "json",
            beforeSend: function () {
              // Show the spinner while fetching
              $("#charts_div").hide();
              $("#loader").show();
              
            },
            complete: function () {
              // As soon as data is fetched, show the graphs
              $("#charts_div").show();
              $("#loader").hide();
            },
            success : function (data) {
              // Load the data into the graphs
              chartData = data;
              console.log(chartData);
              setChart(chartData);
              // setTable(chartData, metrics);
              
            }
          });
          
        }
    });
    



  </script>

</body>
</html>
